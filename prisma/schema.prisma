// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  name              String?
  image             String?
  
  // Game stats
  coins             Int      @default(0)
  xp                Int      @default(0)
  level             Int      @default(1)
  
  // Sugoroku map position (optional for future expansion)
  currentWorldId    String?
  currentTileIndex  Int?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  quests            Quest[]
  userAchievements  UserAchievement[]
  bossHits          BossHit[]
  statsDaily        StatsDaily[]
  statsWeekly       StatsWeekly[]
  world             World?    @relation(fields: [currentWorldId], references: [id])
  
  @@map("users")
}

// ============================================
// Tasks (Quests)
// ============================================

enum TaskDifficulty {
  EASY
  NORMAL
  HARD
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Quest {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  title           String
  description     String?
  difficulty      TaskDifficulty @default(NORMAL)
  
  // Custom fields from API usage
  plannedMinutes  Int?          @map("planned_minutes")
  dueAt           DateTime?     @map("due_at")
  isDaily         Boolean       @default(false) @map("is_daily")
  isUrgent        Boolean       @default(false) @map("is_urgent")
  isTopPriority   Boolean       @default(false) @map("is_top_priority")
  timerColor      String?       @default("red") @map("timer_color")
  
  status          TaskStatus    @default(TODO)
  isCompleted     Boolean       @default(false) @map("is_completed")
  completedAt     DateTime?     @map("completed_at")
  
  // Rewards
  xpReward        Int           @default(0) @map("xp_reward")
  coinReward      Int           @default(0) @map("coin_reward")
  bossDamage      Int           @default(0) @map("boss_damage")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([dueAt])
  @@map("quests")
}

// ============================================
// Achievements System
// ============================================

enum AchievementScope {
  DAILY
  WEEKLY
  LIFETIME
}

model Achievement {
  id          String            @id @default(uuid())
  name        String
  description String?
  scope       AchievementScope
  tier        Int               @default(1) // 1, 2, 3, etc.
  
  // Condition stored as JSON (e.g., "completedTasksToday >= 3")
  condition   Json
  
  // Rewards
  xpReward    Int               @default(0)
  coinReward  Int               @default(0)
  bossDamage  Int               @default(0)
  
  // Optional buffs (stored as JSON)
  buffs       Json?
  
  // Timestamps
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  // Relations
  userAchievements UserAchievement[]
  
  @@index([scope])
  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  
  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("user_achievements")
}

// ============================================
// Boss Raid System
// ============================================

model BossWeek {
  id          String    @id @default(uuid())
  weekKey     String    @unique // Format: "YYYY-MM-DD" (Monday date)
  name        String
  maxHp       Int
  currentHp   Int
  isActive    Boolean   @default(true)
  affix       String?   // Special modifier description
  
  // Timestamps
  startDate   DateTime  @default(now())
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  bossHits    BossHit[]
  
  @@index([weekKey])
  @@index([isActive])
  @@map("boss_weeks")
}

model BossHit {
  id          String    @id @default(uuid())
  userId      String
  bossWeekId  String
  damage      Int
  source      String?   // "task" or "achievement"
  sourceId    String?   // Task ID or Achievement ID
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bossWeek    BossWeek  @relation(fields: [bossWeekId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([bossWeekId])
  @@index([createdAt])
  @@map("boss_hits")
}

// ============================================
// Statistics (for Achievement Evaluation)
// ============================================

model StatsDaily {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @default(now()) @db.Date
  
  // Aggregated stats
  completedTasks    Int      @default(0)
  focusMinutes      Int      @default(0)
  streak            Int      @default(0)
  totalXp           Int      @default(0)
  totalCoins        Int      @default(0)
  totalBossDamage   Int      @default(0)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("stats_daily")
}

model StatsWeekly {
  id                String   @id @default(uuid())
  userId            String
  weekKey           String   // Format: "YYYY-MM-DD" (Monday date)
  
  // Aggregated stats
  completedTasks    Int      @default(0)
  focusMinutes      Int      @default(0)
  streak            Int      @default(0)
  totalXp           Int      @default(0)
  totalCoins        Int      @default(0)
  totalBossDamage   Int      @default(0)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, weekKey])
  @@index([userId])
  @@index([weekKey])
  @@map("stats_weekly")
}

// ============================================
// Sugoroku Map System (for future expansion)
// ============================================

enum TileType {
  EMPTY
  ENEMY
  CHEST
  EVENT
  BOSS
}

model World {
  id          String    @id @default(uuid())
  name        String
  description String?
  isActive    Boolean   @default(true)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  tiles       Tile[]
  users       User[]
  
  @@map("worlds")
}

model Tile {
  id          String    @id @default(uuid())
  worldId     String
  index       Int       // Position on the map
  type        TileType  @default(EMPTY)
  eventData   Json?     // Store event-specific data (enemy stats, chest rewards, etc.)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  world       World     @relation(fields: [worldId], references: [id], onDelete: Cascade)
  
  @@unique([worldId, index])
  @@index([worldId])
  @@index([type])
  @@map("tiles")
}

